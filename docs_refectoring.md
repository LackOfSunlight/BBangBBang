
## 리팩토링 후후 게임 패킷 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              클라이언트 (Client)                                 │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ TCP Socket 연결
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           소켓 레이어 (Socket Layer)                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ on.connection.ts                                                           │ │
│  │ socket.on('data', (chunk) => onData(socket, chunk))                       │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ on.data.ts                                                                 │ │
│  │ 1. 패킷 파싱 (헤더 + 페이로드)                                             │ │
│  │ 2. GamePacket.fromBinary(payloadBuf)                                      │ │
│  │ 3. gamePacketDispatcher(socket, gamePacket)                               │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 패킷 디스패치
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        디스패처 레이어 (Dispatcher Layer)                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ game.packet.dispatcher.ts                                                  │ │
│  │ const handlers = {                                                         │ │
│  │   [GamePacketType.useCardRequest]: useCardHandler,                        │ │
│  │   [GamePacketType.reactionRequest]: reactionHandler,                      │ │
│  │   [GamePacketType.loginRequest]: loginHandler,                            │ │
│  │   ...                                                                     │ │
│  │ }                                                                         │ │
│  │ handler(socket, gamePacket)                                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 핸들러 호출
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          핸들러 레이어 (Handler Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ use.card.handler.ts                                                        │ │
│  │ 1. DTO 검증 (userId, roomId, cardType, targetUserId)                      │ │
│  │ 2. GameActionService.useCard() 호출                                       │ │
│  │ 3. 응답 패킷 생성 및 전송                                                  │ │
│  │ 4. 서비스에서 생성된 알림 패킷들 브로드캐스트                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ reaction.handler.ts                                                        │ │
│  │ 1. DTO 검증 (userId, roomId, reactionType)                                │ │
│  │ 2. GameActionService.resolveReaction() 호출                               │ │
│  │ 3. 응답 패킷 생성 및 전송                                                  │ │
│  │ 4. 서비스에서 생성된 알림 패킷들 브로드캐스트                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 서비스 호출
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          서비스 레이어 (Service Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ GameActionService                                                          │ │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ useCard(userId, roomId, cardType, targetUserId?)                       │ │ │
│  │ │ 1. loadActors() - 액터 로딩                                            │ │ │
│  │ │ 2. executeEffect() - 이펙트 실행                                       │ │ │
│  │ │ 3. applyResults() - 상태 적용 및 알림 패킷 생성                        │ │ │
│  │ │ 4. return { success, failcode, notificationGamePackets }                │ │ │
│  │ └─────────────────────────────────────────────────────────────────────────┘ │ │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ resolveReaction(userId, roomId, reactionType)                          │ │ │
│  │ │ 1. loadActors() - 액터 로딩                                            │ │ │
│  │ │ 2. executeStateBasedReaction() - 상태별 처리                           │ │ │
│  │ │ 3. applyResults() - 상태 적용 및 알림 패킷 생성                        │ │ │
│  │ │ 4. return { success, failcode, notificationGamePackets }                │ │ │
│  │ └─────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 이펙트/유틸 호출
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        이펙트/유틸 레이어 (Effect/Util Layer)                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ effects/                                                                  │ │
│  │ ├── solo/vaccine.effect.handler.ts                                       │ │
│  │ ├── interactive/bbang.effect.handler.ts                                  │ │
│  │ └── interactive/deathMatch.effect.handler.ts                             │ │
│  │                                                                           │ │
│  │ utils/                                                                    │ │
│  │ ├── room.utils.ts (getRoom, getUserFromRoom, updateCharacterFromRoom)   │ │
│  │ ├── notification.sender.ts (sendNotificationGamePackets)                 │ │
│  │ └── notification.builder.ts (createUserUpdateNotificationGamePacket)      │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 데이터베이스/메모리 접근
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        데이터 레이어 (Data Layer)                                │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ 메모리 상태 관리                                                           │ │
│  │ ├── rooms Map<number, Room>                                               │ │
│  │ ├── users Map<string, User>                                              │ │
│  │ └── roomTimers Map<string, NodeJS.Timeout>                                │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 결과 반환 (알림 패킷 포함)
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        이펙트/유틸 레이어 (Effect/Util Layer)                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ effects/                                                                  │ │
│  │ ├── solo/vaccine.effect.handler.ts                                       │ │
│  │ ├── interactive/bbang.effect.handler.ts                                  │ │
│  │ └── interactive/deathMatch.effect.handler.ts                             │ │
│  │                                                                           │ │
│  │ utils/                                                                    │ │
│  │ ├── room.utils.ts (getRoom, getUserFromRoom, updateCharacterFromRoom) │ │
│  │ ├── notification.sender.ts (sendNotificationGamePackets)                 │ │
│  │ └── notification.builder.ts (createUserUpdateNotificationGamePacket)    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 결과 반환 (알림 패킷 포함)
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          서비스 레이어 (Service Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ GameActionService                                                          │ │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ useCard() 결과:                                                         │ │ │
│  │ │ { success: boolean, failcode: GlobalFailCode, notificationGamePackets } │ │ │
│  │ └─────────────────────────────────────────────────────────────────────────┘ │ │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │ │ resolveReaction() 결과:                                                │ │ │
│  │ │ { success: boolean, failcode: GlobalFailCode, notificationGamePackets } │ │ │
│  │ └─────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 결과 반환 (알림 패킷 포함)
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          핸들러 레이어 (Handler Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ use.card.handler.ts                                                        │ │
│  │ 1. DTO 검증 (userId, roomId, cardType, targetUserId)                      │ │
│  │ 2. GameActionService.useCard() 호출                                       │ │
│  │ 3. 응답 패킷 생성 및 전송                                                  │ │
│  │ 4. 서비스에서 생성된 알림 패킷들 브로드캐스트                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ reaction.handler.ts                                                        │ │
│  │ 1. DTO 검증 (userId, roomId, reactionType)                                │ │
│  │ 2. GameActionService.resolveReaction() 호출                               │ │
│  │ 3. 응답 패킷 생성 및 전송                                                  │ │
│  │ 4. 서비스에서 생성된 알림 패킷들 브로드캐스트                              │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │ 응답 패킷 전송 + 알림 패킷 브로드캐스트
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              클라이언트 (Client)                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 상세 패킷 처리 흐름

### 1. **카드 사용 요청 (useCardRequest)**
```
클라이언트 → on.data.ts → game.packet.dispatcher.ts → use.card.handler.ts → GameActionService.useCard() → vaccine.effect.handler.ts → room.utils.ts → 핸들러에서 알림 브로드캐스트
```

### 2. **반응 요청 (reactionRequest)**
```
클라이언트 → on.data.ts → game.packet.dispatcher.ts → reaction.handler.ts → GameActionService.resolveReaction() → executeStateBasedReaction() → room.utils.ts → 핸들러에서 알림 브로드캐스트
```

## 🎯 핵심 개선사항

1. **단일 진입점**: `game.packet.dispatcher.ts`에서 모든 패킷 라우팅
2. **통합 서비스**: `GameActionService`로 모든 게임 액션 통합 관리
3. **공통 로직**: `loadActors`, `applyResults`, `mapErrorToFailCode` 재사용
4. **계층 분리**: 각 레이어의 책임이 명확히 구분
5. **일관성**: 모든 액션에서 동일한 패턴 사용
6. **알림 처리 개선**: 서비스에서 알림 패킷 생성, 핸들러에서 전송하는 단일 책임 분리





## 🏗️ 리팩토링 후 게임 서버 아키텍처 레이어별 상세 설명

### 1. **소켓 레이어 (Socket Layer)**
**개념**: 네트워크 통신의 최하위 레벨을 추상화
**역할**: TCP 소켓 연결, 패킷 파싱, 버퍼 관리

```typescript
// 예시 파일들
on.connection.ts     // 소켓 연결 관리
on.data.ts          // 패킷 수신 및 파싱
on.error.ts         // 에러 처리
on.end.ts           // 연결 종료 처리
```

**추상화 대상**: 
- TCP 소켓의 복잡한 버퍼 관리
- 패킷 헤더 파싱 (payloadType, version, sequence, payloadLength)
- 청크 단위 데이터 수신 및 재조립

---

### 2. **디스패처 레이어 (Dispatcher Layer)**
**개념**: 패킷 타입에 따른 라우팅을 추상화
**역할**: 패킷 타입 식별, 적절한 핸들러로 라우팅

```typescript
// 예시 파일
game.packet.dispatcher.ts

const handlers = {
  [GamePacketType.useCardRequest]: useCardHandler,
  [GamePacketType.reactionRequest]: reactionHandler,
  [GamePacketType.loginRequest]: loginHandler,
  // ... 기타 핸들러들
};
```

**추상화 대상**:
- 패킷 타입별 핸들러 매핑
- 핸들러 선택 로직
- 패킷 라우팅 결정

---

### 3. **핸들러 레이어 (Handler Layer)**
**개념**: HTTP의 Controller와 유사한 역할, 요청 검증과 응답 생성을 추상화
**역할**: DTO 검증, 서비스 호출, 응답 패킷 생성

```typescript
// 예시 파일들
use.card.handler.ts        // 카드 사용 요청 처리
reaction.handler.ts        // 반응 요청 처리
login.handler.ts           // 로그인 요청 처리
create.room.handler.ts     // 방 생성 요청 처리
```

**추상화 대상**:
- 클라이언트 요청의 유효성 검증
- 비즈니스 로직과 네트워크 통신의 분리
- 요청/응답 패킷 변환

---

### 4. **서비스 레이어 (Service Layer)**
**개념**: 비즈니스 로직의 오케스트레이션을 추상화
**역할**: 복잡한 비즈니스 플로우 조율, 트랜잭션 관리

```typescript
// 예시 파일
game.action.service.ts

export class GameActionService {
  useCard()           // 카드 사용 오케스트레이션
  resolveReaction()   // 반응 해결 오케스트레이션
  loadActors()        // 공통 액터 로딩
  applyResults()      // 공통 상태 적용 및 알림 패킷 생성
  mapErrorToFailCode() // 공통 에러 매핑
}
```

**추상화 대상**:
- 복잡한 비즈니스 플로우의 조율
- 여러 도메인 로직의 조합
- 트랜잭션 경계 관리

---

### 5. **이펙트 레이어 (Effect Layer)**
**개념**: 순수한 비즈니스 로직 계산을 추상화
**역할**: 게임 규칙에 따른 상태 변경 계산

```typescript
// 예시 파일들
effects/solo/
├── vaccine.effect.handler.ts           // 백신 카드 효과
├── matured.savings.effect.handler.ts  // 성숙한 저축 효과
└── win.lottery.effect.handler.ts      // 복권 당첨 효과

effects/interactive/
├── bbang.effect.handler.ts            // 빵야 카드 효과
├── deathMatch.effect.handler.ts       // 현피 카드 효과
└── shield.effect.handler.ts           // 방패 카드 효과
```

**추상화 대상**:
- 게임 규칙의 순수한 계산 로직
- 카드별 고유한 효과 처리
- 상태 머신의 전환 로직

---

### 6. **유틸리티 레이어 (Utility Layer)**
**개념**: 공통 기능과 인프라스트럭처를 추상화
**역할**: 데이터 접근, 알림 전송, 유틸리티 함수 제공

```typescript
// 예시 파일들
utils/room.utils.ts              // 방/유저 데이터 관리
utils/notification.sender.ts     // 알림 전송 (현재 미사용, 핸들러에서 직접 브로드캐스트)
utils/notification.builder.ts    // 알림 패킷 생성
utils/type.converter.ts          // 타입 변환
utils/validation.ts              // 데이터 검증
```

**추상화 대상**:
- 데이터베이스/메모리 접근 패턴
- 알림 전송 메커니즘
- 공통 유틸리티 함수들

---

### 7. **데이터 레이어 (Data Layer)**
**개념**: 데이터 저장소와 상태 관리를 추상화
**역할**: 게임 상태 저장, 메모리 관리

```typescript
// 예시 파일들
models/room.model.ts             // 방 데이터 모델
models/user.model.ts             // 유저 데이터 모델
models/character.model.ts        // 캐릭터 데이터 모델

// 메모리 상태 관리
const rooms = new Map<number, Room>();
const users = new Map<string, User>();
const roomTimers = new Map<string, NodeJS.Timeout>();
```

**추상화 대상**:
- 데이터 저장소의 복잡성
- 메모리 상태 관리
- 데이터 모델의 구조

---

## 🎯 레이어별 책임 요약

| 레이어 | 주요 책임 | 추상화 대상 |
|--------|-----------|-------------|
| **소켓** | 네트워크 통신 | TCP 소켓, 패킷 파싱 |
| **디스패처** | 패킷 라우팅 | 패킷 타입별 핸들러 매핑 |
| **핸들러** | 요청/응답 처리 | HTTP Controller 패턴 |
| **서비스** | 비즈니스 오케스트레이션 | 복잡한 플로우 조율 |
| **이펙트** | 순수 비즈니스 로직 | 게임 규칙 계산 |
| **유틸리티** | 공통 기능 | 인프라스트럭처 |
| **데이터** | 상태 관리 | 데이터 저장소 |

